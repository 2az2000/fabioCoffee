# سیستم مدیریت کافه فابیو (Fabio Cafe Management System)

این پروژه یک سیستم کامل مدیریت کافه است که شامل یک بک‌اند (Backend) مبتنی بر Node.js/Express/Prisma و یک فرانت‌اند (Frontend) مبتنی بر Next.js/React است.

## ۱. تحلیل کلی پروژه

### ۱.۱. معماری
پروژه از معماری **Monorepo** استفاده می‌کند که شامل دو بخش اصلی است:
1.  **Backend (`backend/`)**: یک API سرور RESTful برای مدیریت داده‌ها، احراز هویت و منطق کسب و کار.
2.  **Frontend (`frontend/`)**: یک برنامه وب برای نمایش منو به مشتریان و پنل مدیریت برای مدیران.

### ۱.۲. پکیج‌های کلیدی

#### بک‌اند (Backend - Node.js/TypeScript)
| پکیج | کاربرد |
| :--- | :--- |
| `express` | فریم‌ورک اصلی برای ساخت سرور API. |
| `prisma` / `@prisma/client` | ORM (Object-Relational Mapper) برای تعامل با پایگاه داده PostgreSQL. |
| `typescript` / `tsx` | زبان برنامه‌نویسی و ابزار اجرای فایل‌های TypeScript در محیط توسعه. |
| `bcryptjs` | برای هش کردن و اعتبارسنجی رمزهای عبور مدیران. |
| `jsonwebtoken` | برای تولید و اعتبارسنجی توکن‌های JWT (احراز هویت مدیر). |
| `zod` | کتابخانه قدرتمند برای اعتبارسنجی داده‌های ورودی (Validation) در کنترلرها. |
| `swagger-ui-express` / `swagger-jsdoc` | برای تولید و نمایش مستندات API به صورت خودکار از طریق کامنت‌های JSDoc. |
| `cors`, `helmet`, `morgan` | میان‌افزارهای استاندارد برای امنیت، لاگ‌گیری و مدیریت CORS. |

#### فرانت‌اند (Frontend - Next.js/React/TypeScript)
| پکیج | کاربرد |
| :--- | :--- |
| `next` / `react` | فریم‌ورک اصلی برای ساخت رابط کاربری (UI). |
| `framer-motion` | کتابخانه برای افزودن انیمیشن‌های جذاب و روان به عناصر UI. |
| `tailwind-css` | فریم‌ورک CSS برای استایل‌دهی سریع و ریسپانسیو. |
| `@radix-ui/react-*` | مجموعه‌ای از کامپوننت‌های UI بدون استایل (headless) برای ساخت عناصر پیشرفته (مانند Dialog, Tabs). |
| `lucide-react` | مجموعه آیکون‌های سبک و مدرن. |
| `axios` | (در این پروژه از `fetch` استفاده شده، اما `axios` در `package.json` وجود دارد) برای مدیریت درخواست‌های HTTP. |

### ۱.۳. منطق پیاده‌سازی و الگوریتمیک (بک‌اند)

بک‌اند بر اساس الگوی **Controller-Service (ضمنی)** پیاده‌سازی شده است. منطق اصلی در کنترلرها قرار دارد که مستقیماً با کلاینت Prisma تعامل می‌کنند.

1.  **مدیریت داده (Prisma)**:
    *   از PostgreSQL به عنوان دیتابیس استفاده می‌کند.
    *   مدل‌های اصلی شامل `Admin`, `Category`, `Item`, `Table`, `Order`, و `OrderItem` هستند.
    *   رابطه **چند به چند** بین `Order` و `Item` از طریق جدول واسط `OrderItem` مدیریت می‌شود.
    *   از `onDelete: Cascade` در روابط استفاده شده تا حذف یک رکورد اصلی (مانند Category) منجر به حذف رکوردهای وابسته (مانند Item) شود.

2.  **احراز هویت (Auth)**:
    *   از توکن‌های **JWT** برای احراز هویت مدیران استفاده می‌شود.
    *   رمز عبور با استفاده از `bcryptjs` هش می‌شود.
    *   میان‌افزار `authenticateToken` (در [`backend/src/middleware/auth.ts`](backend/src/middleware/auth.ts:9)) مسیرهای مدیریتی را محافظت می‌کند.

3.  **اعتبارسنجی (Validation)**:
    *   تمامی ورودی‌های API (مانانند ایجاد آیتم یا ورود) با استفاده از کتابخانه **Zod** اعتبارسنجی می‌شوند. این کار امنیت و پایداری API را تضمین می‌کند.

4.  **منطق سفارش (Order Logic)**:
    *   در کنترلر `createOrder`، قبل از ثبت سفارش، وجود `Table` و فعال بودن تمام `Item`های سفارش داده شده بررسی می‌شود.
    *   `totalPrice` سفارش در لحظه ثبت، با جمع قیمت‌های فعلی آیتم‌ها محاسبه و ذخیره می‌شود. این کار تضمین می‌کند که قیمت سفارش حتی اگر قیمت آیتم‌ها در آینده تغییر کند، ثابت بماند.

5.  **مدیریت خطا (Error Handling)**:
    *   میان‌افزار `errorHandler` (در [`backend/src/middleware/error.ts`](backend/src/middleware/error.ts:8)) خطاهای مختلف (Zod, JWT, Prisma) را به صورت متمرکز مدیریت کرده و پاسخ‌های استاندارد JSON (شامل `success: false` و پیام خطا) برمی‌گرداند.

### ۱.۴. ساختار پیاده‌سازی (فرانت‌اند)

فرانت‌اند یک برنامه Next.js است که از قابلیت‌های **App Router** استفاده می‌کند.

1.  **بخش مشتری (Public)**:
    *   صفحه اصلی (`frontend/src/app/page.tsx`) شامل کامپوننت‌های `Hero` (معرفی) و `Menu` (منو و سفارش‌گیری) است.
    *   کامپوننت `Menu` منطق اصلی نمایش دسته‌بندی‌ها و آیتم‌ها را مدیریت می‌کند و از کامپوننت‌های UI سفارشی (مانند Tabs و Card) استفاده می‌کند.
    *   کامپوننت `Cart` (سبد خرید) به صورت یک سایدبار متحرک پیاده‌سازی شده و وضعیت سبد خرید را مدیریت می‌کند.

2.  **پنل مدیریت (Admin Panel)**:
    *   مسیرهای مدیریتی در پوشه `frontend/src/app/admin/` قرار دارند.
    *   `frontend/src/app/admin/layout.tsx` به عنوان لایه اصلی پنل مدیریت، شامل نوار کناری (Sidebar) و مهم‌تر از همه، **منطق محافظت از مسیرها** است. این لایه با بررسی `adminToken` در `localStorage`، دسترسی غیرمجاز را به صفحه ورود هدایت می‌کند.
    *   صفحات مدیریتی (مانند `categories/page.tsx`, `items/page.tsx`, `tables/page.tsx`) برای مدیریت CRUD (ایجاد، خواندن، به‌روزرسانی، حذف) داده‌ها استفاده می‌شوند (اگرچه برخی از این صفحات در حال حاضر خالی هستند، اما ساختار آن‌ها تعریف شده است).

3.  **سرویس API (Client)**:
    *   فایل [`frontend/src/lib/api.ts`](frontend/src/lib/api.ts) یک کلاس `ApiService` را تعریف می‌کند که تمام تعاملات با بک‌اند را کپسوله می‌کند. این سرویس به طور خودکار توکن JWT مدیر را به هدر درخواست‌های محافظت شده اضافه می‌کند.

## ۲. روش اجرای پروژه

برای اجرای کامل پروژه (بک‌اند و فرانت‌اند)، مراحل زیر را دنبال کنید.

### ۲.۱. پیش‌نیازها

*   Node.js (نسخه ۱۸ به بالا)
*   PostgreSQL (برای دیتابیس بک‌اند)

### ۲.۲. راه‌اندازی بک‌اند (Backend)

1.  **نصب وابستگی‌ها**:
    ```bash
    cd backend
    npm install
    ```

2.  **پیکربندی متغیرهای محیطی**:
    *   فایل `.env.example` را به `.env` کپی کنید.
    *   متغیر `DATABASE_URL` را با آدرس اتصال به دیتابیس PostgreSQL خود تنظیم کنید.
    *   متغیر `JWT_SECRET` را به یک رشته تصادفی و قوی تغییر دهید.

3.  **راه‌اندازی دیتابیس و Seed**:
    *   شمای Prisma را به دیتابیس اعمال کنید:
        ```bash
        npm run db:migrate
        ```
    *   داده‌های اولیه (مانند یک مدیر پیش‌فرض) را وارد کنید:
        ```bash
        npm run seed
        ```
        (توجه: فایل [`backend/src/scripts/seed.ts`](backend/src/scripts/seed.ts) باید حاوی منطق ایجاد مدیر پیش‌فرض باشد.)

4.  **اجرای سرور بک‌اند**:
    ```bash
    npm run dev
    ```
    سرور در پورت `3001` اجرا خواهد شد. مستندات API در آدرس `http://localhost:3001/api-docs` قابل دسترسی است.

### ۲.۳. راه‌اندازی فرانت‌اند (Frontend)

1.  **نصب وابستگی‌ها**:
    ```bash
    cd frontend
    npm install
    ```

2.  **اجرای برنامه فرانت‌اند**:
    ```bash
    npm run dev
    ```
    برنامه در پورت `3000` (یا پورت پیش‌فرض Next.js) اجرا خواهد شد.
